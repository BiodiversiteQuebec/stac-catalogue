---
title: "Using the STAC catalogue to load current and future climate data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("gdalcubes")
library("rstac")
library("tibble")
library("sp")
library("sf")
library("dplyr")
library("rgbif")
library("tidyr")
library("stars")
#library("stacatalogue")
devtools::load_all()
# devtools::test()
devtools::document()
devtools::install()
```


### Exploring the STAC

We print the different collections from the STAC:

* chelsa-clim: current climate data (mean from 1981 to 2011) from CHELSA, categories "bioclim" (see the definitions of variables [here](https://www.worldclim.org/data/bioclim.html))
* chelsa-clim-proj: climate data (bioclim list) projected from 2041-2070 and 2071-2100, for different climatic scenario and CHELSA climatic model (see [CHELSA project](https://chelsa-climate.org/cmip6/)).
* chelsa-monthly: monthly bioclim variables from CHELSA #TO COMPLETE
* esacci-lc: ESA land cover from 1992 to 2020 (yearly) (see [ESA-CCI project](https://www.esa-landcover-cci.org/)).
* ghmts: global human modification index, a continuous 0-1 metric that reflects the proportion of a landscape modified, based on modeling the physical extents of 13 anthropogenic stressors (see [GHM project](https://sedac.ciesin.columbia.edu/data/set/lulc-human-modification-terrestrial-systems)).

```{r}
stac("http://io.biodiversite-quebec.ca/stac/") %>%
  collections() %>%
  get_request()

``` 

### Loading observations

Let's download [Glyptemys insculpta](https://en.wikipedia.org/wiki/Wood_turtle) observations from GBIF.

```{r}
obs <- rgbif::occ_data(scientificName = "Glyptemys insculpta", hasCoordinate = TRUE, limit = 100)$data
obs <- CoordinateCleaner::cc_val(obs, lon = "decimalLongitude", 
                                 lat = "decimalLatitude", verbose = T, value = "clean")

obs <- CoordinateCleaner::cc_zero(obs, lon = "decimalLongitude", 
                                        lat = "decimalLatitude", buffer = 0.5, 
                                        verbose = T, value = "clean")
obs <- dplyr::select(obs, decimalLongitude, decimalLatitude) %>%
  dplyr::rename(lon = decimalLongitude) %>%
  dplyr::rename(lat = decimalLatitude) 

```

We reproject the decimal longitude and latitude to a user-specified projection system. This conversion to a projected system is essential to interact with the cube.

```{r}
srs.obs <-"EPSG:4326" # initial observations projection system
srs.cube <- "EPSG:6623" # targeted projected projection system
obs.coords.proj <- create_projection(obs, lon = "lon", lat = "lat", 
                                       srs.obs, srs.cube)
head(obs.coords.proj )
```

### Filter classes
                         
Let\'s select crop areas (class 11) and load it at the native resolution (250m) from 2000 to 2001 (2 years). We set prop to FALSE.
```{r, warning=FALSE}
plot_categorical <- function(r) {
  values <- unique(data.frame(terra::rast(r[[1]]))[,1])
  my_col <- rev(terrain.colors(n = length(values)+1))
  plot(r, legend = FALSE, col = my_col)
  legend(x = "topright", legend = values, fill = my_col[-1])
}
urban_2000_2001 <-load_prop_values(stac_path = "https://io.biodiversite-quebec.ca/stac/",
                                collections = c("esacci-lc"), 
                                use.obs = T,
                                obs = obs.coords.proj,
                                buffer.box = 0,
                                srs.cube = srs.cube,
                                t0 = "2000-01-01",
                                t1 = "2001-12-31",
                                spatial.res = 250, # in meters
                                prop = F,
                                select_values = c(11),
                                temporal.res =  "P1Y")

```
```{r, warning=FALSE}
plot_categorical(a$y2000_class11)
plot_categorical(a$y2001_class11)
```
